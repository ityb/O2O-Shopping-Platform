<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ityb.qugou.job.mapper.JobMapper">
	<select id="batchUpdateStateJob" statementType="CALLABLE" >
		<!-- DROP PROCEDURE IF EXISTS CART_NEW_H_LIST;  
		CREATE PROCEDURE CART_NEW_H_LIST()  
		BEGIN  
		    DECLARE  S_ID VARCHAR(32) DEFAULT NULL;
			DECLARE  B_NUMBER INT(9) DEFAULT 0;
			DECLARE  IS_COUNT INT(9) DEFAULT 0;
			DECLARE  M_TIME TIMESTAMP;
		    DECLARE FINISHED INT  DEFAULT 0; 
		    DECLARE CART_NOW_LIST CURSOR FOR SELECT SPECIFICATION_ID,BUY_NUMBER,CTIME FROM T_P_CART WHERE DATE(NOW())>DATE(CTIME) AND CART_TYPE=1 AND ISVALID=1;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1; 
			OPEN  CART_NOW_LIST;     
		    READ_LOOP:LOOP
	            FETCH CART_NOW_LIST INTO S_ID,B_NUMBER,M_TIME;
					IF FINISHED=1 THEN
	               		LEAVE READ_LOOP;
	            	END IF; 
					SELECT COUNT(*) FROM T_P_CART WHERE CART_TYPE=2 AND SPECIFICATION_ID=S_ID AND ISVALID=1 INTO IS_COUNT;
					IF IS_COUNT=0 THEN
							UPDATE T_P_CART SET CART_TYPE=2 WHERE CART_TYPE=1 AND SPECIFICATION_ID=S_ID AND ISVALID=1;
					ELSE 
						UPDATE T_P_CART SET BUY_NUMBER=BUY_NUMBER+B_NUMBER,CTIME=M_TIME WHERE CART_TYPE=2 AND SPECIFICATION_ID=S_ID AND ISVALID=1;
						UPDATE T_P_CART SET ISVALID=0 WHERE CART_TYPE=1 AND SPECIFICATION_ID=S_ID AND ISVALID=1;
           			END IF;
		    END LOOP;
			CLOSE CART_NOW_LIST;
		COMMIT;
		END;  -->
		<![CDATA[ 
			CALL CART_NEW_H_LIST();
		]]>
	</select>
	
	
	<select id="batchCancelOrderJob" statementType="CALLABLE" parameterType="string">
		<!-- DROP PROCEDURE IF EXISTS BATCH_CANCEL_ORDER;  
		CREATE PROCEDURE BATCH_CANCEL_ORDER(IN CANCEL_TIME VARCHAR(32))  
		BEGIN  
			DECLARE O_ID VARCHAR(32) DEFAULT NULL;
			DECLARE  IS_OCOUNT INT(9) DEFAULT 0;
			DECLARE FINISHED INT  DEFAULT 0; 
			DECLARE ORDER_LIST CURSOR FOR SELECT ID FROM T_P_ORDER WHERE  STATE=-1 AND TRADE_WAY=2 AND  ISVALID=1 AND DATE_FORMAT(CTIME, '%Y%M%D%H%I')<=CANCEL_TIME ;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1; 
			OPEN  ORDER_LIST;     
			READ_LOOP:LOOP
            	FETCH ORDER_LIST INTO O_ID;
			IF FINISHED=1 THEN
             	LEAVE READ_LOOP;
	        END IF; 
				SELECT COUNT(*) FROM T_P_ORDER WHERE ID=O_ID AND ISVALID=1 INTO IS_OCOUNT;
				IF IS_OCOUNT>0 THEN
					UPDATE T_P_ORDER SET STATE=-3 WHERE ID=O_ID;
         	END IF;
		    END LOOP;
			CLOSE ORDER_LIST;
		COMMIT;
		END; -->
		<![CDATA[ 
			CALL BATCH_CANCEL_ORDER(#{canelTime});
		]]>
	</select>
</mapper>